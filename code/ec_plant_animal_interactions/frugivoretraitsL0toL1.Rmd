---
title: 'Frugivoria: Ecuadorian Birds & Mammals (L0 to L1)'
author: "Beth Gerstner"
date: "6/17/2020"
description: This script is part of the overarching Frugivoria project, which aims to build a comprehensive database of functional traits for birds and mammals (frugivores) in Central and South American tropical forests. This smaller project focuses on birds and mammals in Ecuador and will eventually be used to understand plant/animal interactions. 
output:
  pdf_document: default
  html_document: default
---
# Load packages and IUCN API
```{r, message=FALSE}
library(httr) 
library(jsonlite)
library(dplyr)
library(rredlist) 

token <- '3b3db1c753a7cad0616e16146363ec88eead97d185cb3304070d7343123516fd'
```

# Pull in Ecuadorian species from IUCN Redlist
```{r}
#Ecuador
ecuador_species <- rl_sp_country("EC", key = token, parse = TRUE)
c1 <- ecuador_species$result[1]

```

# Break down by species group for the world (will subset to Ecuadorian species)
```{r}

# Get codes for the birds
all_birds <-rl_comp_groups(group = c('birds'), key = token)

# Get codes for the mammals
all_mammals <-rl_comp_groups(group = c('mammals'), key = token)

```

# Mammals and birds occurring in Ecuador 
```{r}

#Mammals

#South America
#extract IUCN results for all mammals and birds from list
all_mammals_df <- as.data.frame(all_mammals[['result']])
all_birds_df <- as.data.frame(all_birds[['result']])

#Mammals
ec_mammals <-all_mammals_df %>%
  filter(taxonid %in% c1$taxonid)


#Birds
ec_birds <-all_birds_df %>%
  filter(taxonid %in% c1$taxonid)

```

# Get habitat for each species --------------------------------------------
# want lowland montane and highland montane species

```{r}
# Include error-checking code in the function so that it will return NA for everything if there's no data.

get_habitat <- function(ID) {
    habitat_by_sp<- rl_habitats(id=ID,key=token)$result
    if (class(habitat_by_sp) == 'data.frame') {
        data.frame(taxonid=ID, habitat_by_sp)
    } else {
        data.frame(taxonid=ID)
    }
}
```

# Apply get_habitat to each row of ec_mammals
```{r}

ec_habitat_mammals <- ec_mammals %>%
  rowwise %>%
  do(get_habitat(.$taxonid))

```

# Apply get_habitat to each row of_birds

```{r}
ec_habitat_birds <- ec_birds %>%
  rowwise %>%
  do(get_habitat(.$taxonid))


```

# Merge the habitat data with the IUCN list so that we have the statuses and habitats combined
```{r}

mammal_IUCN_full<- merge.data.frame(ec_mammals, ec_habitat_mammals, by= "taxonid", all=TRUE)

bird_IUCN_full<- merge.data.frame(ec_birds, ec_habitat_birds, by= "taxonid", all=TRUE)


```

# Pull in Elton Traits data to begin subsetting to frugivores

```{r}
#Read in Elton Traits dataset 
birds <- read.csv("/Volumes/GoogleDrive/Shared drives/SpaCE_Lab_FRUGIVORIA/L0/Elton_traits/BirdFuncDat.csv")
mamm <- read.csv("/Volumes/GoogleDrive/Shared drives/SpaCE_Lab_FRUGIVORIA/L0/Elton_traits/MamFuncDat.csv")
```

# Combine bird elton traits dataset (full) and IUCN bird dataset for Ecuador together
```{r}

#Combine mammal elton traits dataset and IUCN mammal data together
colnames(mamm)[which(names(mamm) == "Scientific")] <- "scientific_name"
mamm_trait_IUCN <- merge.data.frame(mamm, mammal_IUCN_full, by= "scientific_name", all.y=TRUE)

#Combine bird elton traits dataset and IUCN bird data together
colnames(birds)[which(names(birds) == "Scientific")] <- "scientific_name"
bird_trait_IUCN<- merge.data.frame(birds, bird_IUCN_full, by= "scientific_name", all.y=TRUE)

```

# Go through the merges that did not work correctly (kept all IUCN species that were not found in the Elton Traits database) and compare against synonym lists

```{r}
# Correcting issues with species not merging correctly between databases
#find species that did not match correctly
mamm_trait_na <-mamm_trait_IUCN[is.na(mamm_trait_IUCN$Diet.Vunk),] #205 IUCN mammal species didn't merge
```

#Find species that match alternate names. Lookup table for species is found in code 'scientific_name_lookup_table'
```{r}
#read in lookup table made previously
mam_lookup_final <- read.csv("/Volumes/GoogleDrive/Shared drives/SpaCE_Lab_FRUGIVORIA/L1/working_databases/lookup_tables/CSA_mam_trait_lookups_final_1_7.csv")

# Find species that didn't merge correctly in the lookup table
alternate_match <-unique(as.data.frame(mamm_trait_na$scientific_name[mamm_trait_na$scientific_name %in% mam_lookup_final$IUCN_species_name]))

colnames(alternate_match)[which(names(alternate_match) == "mamm_trait_na$scientific_name[mamm_trait_na$scientific_name %in% mam_lookup_final$IUCN_species_name]")] <- "IUCN_name_with_alternate"

#choose row in lookup table with the alternate match and get the IUCN name
mamm_lookup_subset <-mam_lookup_final %>%
  filter(IUCN_species_name %in% alternate_match$IUCN_name_with_alternate)

#add column to the first merge so that we can keep track of IUCN names vs. alternate names 
mamm_trait_IUCN$IUCN_name <- ""

#Merge list of alternate names with elton_traits and append them to the orginal merge 
mamm_trait_alternates <- merge.data.frame(mamm, mamm_lookup_subset, by.x=c("scientific_name"), by.y=c("elton_name"))

## Remove duplicates with NAs

#transform the alternate names so I can subset the merged dataset and remove those names (will re-attach edited names)
alternates_matrix <-rbind(as.matrix(mx_mamm_trait_alternates$scientific_name), as.matrix(mx_mamm_trait_alternates$IUCN_species_name))

alternates_df <- as.data.frame(alternates_matrix)

#Remove the duplicate species names (wrong names and correct names) because we'll be merging them back in

mam_trait_alt_subset <-mx_mamm_trait %>%
  filter(!scientific_name %in% alternates_df$V1)

# Add IUCN information back into the subset
mx_mamm_trait_alternates_IUCN_info <- merge(mx_mamm_trait_alternates, mx_mammals, by.x="IUCN_species_name",by.y="scientific_name")

```
